
## タスク定義を作る
ecs-cli compose --project-name fargate-example --file docker-compose.yml --ecs-params ecs-params.yml create --launch-type FARGATE  --region ap-northeast-1 


ここで作ったタスク定義にはMount point が含まれないので、手で設定する？？？？
        "mountPoints": [
            {
                "containerPath": "/var/www/html",
                "sourceVolume": "fargate-efs"
            }
        ],


## compooseからサービスを作成する。

ただし、タスク定義を更新しても、更新されたやつを使ってくれないみたい,,,

timeout 30m ecs-cli compose \
  --file docker-compose.yml \
  --ecs-params ecs-params.yml \
  --project-name fargate-go-example\
  --cluster fargate-go-example \
 service up --launch-type FARGATE \
 --container-name fargate-go-example \
 --container-port 8080 \
 --target-group-arn arn:aws:elasticloadbalancing:ap-northeast-1:460256653427:targetgroup/fargate-go-example/077971b302a95ac2 \
 --region ap-northeast-1 \
 --timeout 30



タスク単体アップ
ecs-cli compose --project-name fargate-go-example --cluster fargate-go-example --file docker-compose.yml --ecs-params ecs-params.yml up --launch-type FARGATE  --region ap-northeast-1 




## サービスを作成する。
aws ecs create-service --cluster fargate-go-example --service-name fargate-go-example \
--task-definition fargate-go-example:3 --desired-count 1 --launch-type "FARGATE" \
--platform-version 1.4.0 \
targetGroupArn=string,loadBalancerName=string,containerName=string,containerPort=8080 \
--network-configuration "awsvpcConfiguration={subnets=[subnet-0c36b71dc5e85f4a5,subnet-0c36b71dc5e85f4a5],securityGroups=[sg-0dffaf10baf842450],assignPublicIp=ENABLED}"  --region ap-northeast-1


もしくは

aws ecs create-service --cli-input-json file://service.json  --region ap-northeast-1


## 稼働中のサービス定義jsonを取得する。
aws ecs describe-services --cluster fargate-go-example --services fargate-go-example  --region ap-northeast-1  



## EC2 から EFSをマウントする 

amazon-efs-utilsをEC2にインストールする
https://qiita.com/SSMU3/items/fe2f6b74ab363b39e2f6

SSMでログインして以下のコマンドを実行する
sudo mkdir -p /mnt/efs
sudo mount -t efs fs-1ef8ec3f:/ /mnt/efs





# ハマったところ

## ECSのARNとResource IDのフォーマット設定してなくてハマった
https://qiita.com/narisada014/items/fdc18a7e0dedcc511279


- Task定義にMountpointsをせっていしていなかった
　docker-composeとecs-paramsから作ったが
　ecs-paramsにはmountpointsに関する項目がなかった
　→手動で追加した

FargateからEFSのrootボリュームのパスを / 以外に変更する場合は
予めEFS内にマウントしたいディレクトリを作って置く必要がある  多分EC2などから。

